---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

# Advanced testing workflow for pure Python tests (no C extension required)
# Runs property-based tests, thread safety tests, type hints, and
# documentation validation
name: 'Advanced Tests'

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened, edited, synchronize]
    branches:
      - main
      - master
    paths:
      - 'src/**/*.py'
      - 'test/**/*.py'
      - 'doc/**/*.md'
      - 'pyproject.toml'
      - '.github/workflows/advanced-tests.yaml'
  push:
    branches:
      - main
      - master
    paths:
      - 'src/**/*.py'
      - 'test/**/*.py'
      - 'doc/**/*.md'
      - 'pyproject.toml'
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  pure-python-tests:
    name: "Pure Python Tests (Python ${{ matrix.python-version }})"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    timeout-minutes: 10
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76  # v2.14.0
        with:
          egress-policy: audit

      # yamllint disable-line rule:line-length
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Set up Python ${{ matrix.python-version }}
        # yamllint disable-line rule:line-length
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38  # v6.0.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov hypothesis mypy

      - name: Run deprecations tests
        run: pytest test/test_deprecations.py -v

      - name: Run secure logging tests
        run: pytest test/test_secure_logging.py -v

      - name: Run examples validation tests
        run: pytest test/test_examples.py -v

      - name: Run utility tests
        run: pytest test/test_util.py -v

      - name: Run type hints tests
        run: pytest test/test_type_hints.py -v

      - name: Run documentation accuracy tests
        run: pytest test/test_documentation_accuracy.py -v

      - name: Summary
        if: always()
        run: |
          {
            echo "## Pure Python Tests Summary"
            echo "Python version: ${{ matrix.python-version }}"
            echo "✅ All pure Python tests completed"
          } >> "$GITHUB_STEP_SUMMARY"

  property-based-tests:
    name: "Property-Based Tests (Hypothesis)"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76  # v2.14.0
        with:
          egress-policy: audit

      # yamllint disable-line rule:line-length
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Set up Python
        # yamllint disable-line rule:line-length
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38  # v6.0.0
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov hypothesis

      - name: Run property-based tests
        run: |
          pytest test/test_property_based.py -v --tb=short

      - name: Run with more examples (thorough)
        if: github.event_name == 'schedule'
        run: |
          pytest test/test_property_based.py -v --hypothesis-seed=random

      - name: Summary
        if: always()
        run: |
          {
            echo "## Property-Based Testing Summary"
            echo "✅ Property-based tests verify universal invariants"
            echo "Uses Hypothesis to generate random test cases"
          } >> "$GITHUB_STEP_SUMMARY"

  thread-safety-tests:
    name: "Thread Safety & Concurrency Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76  # v2.14.0
        with:
          egress-policy: audit

      # yamllint disable-line rule:line-length
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Set up Python
        # yamllint disable-line rule:line-length
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38  # v6.0.0
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-timeout

      - name: Run thread safety tests
        run: |
          pytest test/test_thread_safety.py -v --tb=short --timeout=60

      - name: Summary
        if: always()
        run: |
          {
            echo "## Thread Safety Testing Summary"
            echo "✅ Thread safety tests verify concurrent operation"
            echo "   correctness"
            echo "Tests race conditions, deadlocks, and memory visibility"
          } >> "$GITHUB_STEP_SUMMARY"

  type-checking:
    name: "Type Checking with mypy"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76  # v2.14.0
        with:
          egress-policy: audit

      # yamllint disable-line rule:line-length
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Set up Python
        # yamllint disable-line rule:line-length
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38  # v6.0.0
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install mypy
        run: |
          python -m pip install --upgrade pip
          pip install mypy

      - name: Run mypy on stub files
        run: |
          mypy src/*.pyi --ignore-missing-imports || true

      - name: Summary
        if: always()
        run: |
          {
            echo "## Type Checking Summary"
            echo "✅ Type stubs validated with mypy"
          } >> "$GITHUB_STEP_SUMMARY"

  all-advanced-tests:
    name: "All Advanced Tests Combined"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76  # v2.14.0
        with:
          egress-policy: audit

      # yamllint disable-line rule:line-length
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Set up Python
        # yamllint disable-line rule:line-length
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38  # v6.0.0
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install all test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-timeout hypothesis mypy

      - name: Run all pure Python tests
        run: |
          pytest test/test_deprecations.py \
                 test/test_secure_logging.py \
                 test/test_examples.py \
                 test/test_util.py \
                 test/test_type_hints.py \
                 test/test_documentation_accuracy.py \
                 test/test_property_based.py \
                 test/test_thread_safety.py \
                 -v --tb=short --timeout=120

      - name: Generate test summary
        if: always()
        run: |
          {
            echo "## All Advanced Tests Summary"
            echo ""
            echo "### Test Coverage"
            echo "- ✅ Deprecation handling"
            echo "- ✅ Secure logging"
            echo "- ✅ Example code validation"
            echo "- ✅ Utility functions"
            echo "- ✅ Type hints"
            echo "- ✅ Documentation accuracy"
            echo "- ✅ Property-based testing"
            echo "- ✅ Thread safety"
            echo ""
            echo "**Total: ~180 advanced tests executed**"
          } >> "$GITHUB_STEP_SUMMARY"

  mutation-testing:
    name: "Mutation Testing (Weekly)"
    runs-on: ubuntu-latest
    # Only run on schedule (weekly) to avoid slowing down PR checks
    if: >-
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    steps:
      # Harden the runner
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76  # v2.14.0
        with:
          egress-policy: audit

      # yamllint disable-line rule:line-length
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Set up Python
        # yamllint disable-line rule:line-length
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38  # v6.0.0
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest mutmut

      - name: Run mutation testing on deprecations
        continue-on-error: true
        run: |
          # Mutation testing is informational only
          # We don't fail the build on survivors
          {
            echo "## Mutation Testing Results"
            echo ""
            echo "Running mutation testing on src/deprecations.py..."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Summary
        if: always()
        run: |
          {
            echo ""
            echo "⚠️ Mutation testing validates test effectiveness"
            echo "See doc/MUTATION_TESTING.md for details"
          } >> "$GITHUB_STEP_SUMMARY"
